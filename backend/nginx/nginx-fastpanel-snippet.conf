# Фрагмент для внешнего Nginx (FastPanel). SSL настраивает панель (Certbot вне Docker).
# В панели добавьте сайт asteys.ru, включите SSL. Затем в конфиг сервера вставьте блоки:
# Статика и медиа читаются напрямую с хоста (см. bind-монты в docker-compose):
# Раздача статики/медиа с диска хоста

# 1) HTTP -> HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name asteys.ru www.asteys.ru;
    return 301 https://$host$request_uri;
}

# 2) (опц.) www -> apex на HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.asteys.ru;

    ssl_certificate         /var/www/httpd-cert/fullchain.pem;
    ssl_certificate_key     /var/www/httpd-cert/asteys.ru_2025-11-12-20-29_31.key;
    ssl_trusted_certificate /var/www/httpd-cert/chain.pem;

    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 1.1.1.1 8.8.8.8 valid=300s;
    resolver_timeout 5s;

    return 301 https://asteys.ru$request_uri;
}

# 3) Основной сайт на HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name asteys.ru;

    ssl_certificate         /var/www/httpd-cert/fullchain.pem;
    ssl_certificate_key     /var/www/httpd-cert/asteys.ru_2025-11-12-20-29_31.key;
    ssl_trusted_certificate /var/www/httpd-cert/chain.pem;

    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 1.1.1.1 8.8.8.8 valid=300s;
    resolver_timeout 5s;

    include /etc/nginx/fastpanel2-includes/*.conf;
    include "/etc/nginx/fastpanel2-sites/userlab/asteys.ru.includes";

    location /static/ {
        alias /var/www/userlab/data/webdevlabs/staticfiles/;
        access_log off;
        expires 30d;
        add_header Cache-Control 'public, max-age=2592000';
    }

    location /media/ {
        alias /var/www/userlab/data/webdevlabs/media/;
        add_header Cache-Control 'no-cache';
    }

    location / {
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_pass http://127.0.0.1:8001;   # пока контейнер не поднят — тут будет 502, это норм
    }

    error_log  /var/www/userlab/data/logs/asteys.ru-frontend.error.log;
    access_log /var/www/userlab/data/logs/asteys.ru-frontend.access.log;
}
